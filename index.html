<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>リンバス所持人格E.G.O共有ツール</title>
    <style>
        #buttons-container {
        display: grid; /* グリッドレイアウトを使用 */
        grid-template-columns: repeat(2, max-content); /* 2列に分割 */
        gap: 10px; /* ボタン間の余白 */
        }

        .sharelist-group {
            display: flex;
            flex-wrap: wrap;
        }
        
        .global-group{
            display: none;
            flex-wrap: wrap;
        }

        .container {
            display: flex;
            flex-direction: column;
            width: 80px; /* コンテナの幅を指定 */
            transition: width 0.3s;
            position: relative;
        }

        .img {
            width: 80px;
            height: 80px;
            transition: width 0.3s, height 0.3s;
            cursor: pointer;
        }

        .overlay {
            position: absolute;
            width: calc(480px / 7);
            height: calc(160px / 7);
            top: calc(80px - 160px / 7);
            left: calc(40px - 240px / 7);
            transition: width 0.3s, height 0.3s, top 0.3s, left 0.3s;
            cursor: pointer;
        }
        
        button,summary,input[type="checkbox"],input[type="radio"] {
            cursor: pointer;
        }

        .lv-container {
            display: none;
            justify-content: center;
            align-items: center; 
            margin : 3px 0;
            gap: 8px; /* テキストと入力フィールドの間にスペース */
        }

        .lvinput {
            width: 30px;
        }

        textarea{
            width: 90%;
            resize:none;
        }

        input[type="radio"] {
            margin-left: 20px; 
        }

        #blink-sort-reset {
            display: none;
        }

        .reset {
            display: none;
            margin : 5px 0;
        }

        span {
        white-space: pre;
        }

        .custom-space {
            height: 5px;
        }

        #customWidth {
            width: 40px;
        }

        .indent {
            padding-left: 20px;
        }

    </style>
</head>

<body>
    <h2>リンバス所持人格E.G.O共有ツール</h2>
    <p>画像をクリックして強化段階を変更できます。<br>
        実装順に並んでいます。<br>
        一番下に共有用URLが表示されます。</p>
        画像のオプション<br>
            <span class="indent">画像サイズ:</span><div id="imgSizeForm">
                <input type="radio" name="imgSize" value="size1">小
                <input type="radio" name="imgSize" value="size2" checked>中
                <input type="radio" name="imgSize" value="size3">大
                <input type="radio" name="imgSize" value="size4">特大<br>
                <input type="radio" name="imgSize" value="custom">カスタム <input type="number" id="customWidth" disabled>px
            </div>
            <span class="indent"></span><input type="checkbox" id="monochrome" checked> 未所持を暗く表示する<br>
            <input type="radio" name="Uptie" value="default" checked>同期化段階に合わせて画像を表示する<br>
            <input type="radio" name="Uptie" value="before">つねに同期前の画像を表示する<br>
            <input type="radio" name="Uptie" value="after">つねに同期後の画像を表示する<br>
            <span class="indent"></span><input type="checkbox" id="overlay"> 強化段階のラベルを表示しない<br>
            <br>

    ・共有する側に向けてのオプション<br>
    <input type="checkbox" id="enableLv"> Lv共有機能を有効にする（未所持の人格のLvは共有できません）<br>
    <input type="checkbox" id="enableReset"> 強化段階の一括変更ボタンを表示する
    <span class="reset"><br>全囚人を一括で変更する:</span>
    <button class="reset" id="reset0-1">初期人格E.G.Oのみ同期/解析1で所持</button>
    <button class="reset" id="reset0-2">初期人格E.G.Oのみ同期/解析2で所持</button>
    <button class="reset" id="reset0-3">初期人格E.G.Oのみ同期/解析3で所持</button>
    <div id="buttons-container">
        <button class="reset" id="Identity-reset1">人格を全て同期1に</button>
        <button class="reset" id="E.G.O-reset1">E.G.Oを全て解析1に</button>
        <button class="reset" id="Identity-reset2">人格を全て同期2に</button>
        <button class="reset" id="E.G.O-reset2">E.G.Oを全て解析2に</button>
        <button class="reset" id="Identity-reset3">人格を全て同期3に</button>
        <button class="reset" id="E.G.O-reset3">E.G.Oを全て解析3に</button>
        <button class="reset" id="Identity-reset4">人格を全て同期4に</button>
        <button class="reset" id="E.G.O-reset4">E.G.Oを全て解析4に</button>
        <br>
    </div>
    <details>
        <summary>共有された側に向けてのオプション(この行をクリックして開閉)</summary>
        <br>
        <input type="checkbox" id="none-alt0">未所持を表示しない
        <input type="checkbox" id="flex-alt0">未所持のみ表示する<br>
        <input type="checkbox" id="none-id1">初期人格E.G.Oを表示しない<br><br>
        <div>
            それぞれの囚人ごとに<br>
            <input type="radio" name="sort" value="option1"> 同期,解析段階優先でソート<br>
            <input type="radio" name="sort" value="option2"> レベル優先でソート<br>
            すべての囚人を<br>
            <input type="radio" name="sort" value="option3"> 同期,解析段階優先でソート<br>
            <input type="radio" name="sort" value="option4"> レベル優先でソート<br>
        </div>
            <button id="sort-reset">並びを初期化する</button>
    </details>
    <br>
    <div class="sharelist-group" id="sharelist-group1"></div>
    <div class="custom-space"></div>
    <div class="reset" id ="resetButton1"></div>
    <div class="sharelist-group" id="sharelist-group2"></div>
    <div class="custom-space"></div>
    <div class="reset" id ="resetButton2"></div>
    <div class="sharelist-group" id="sharelist-group3"></div>
    <div class="custom-space"></div>
    <div class="reset" id ="resetButton3"></div>
    <div class="sharelist-group" id="sharelist-group4"></div>
    <div class="custom-space"></div>
    <div class="reset" id ="resetButton4"></div>
    <div class="sharelist-group" id="sharelist-group5"></div>
    <div class="custom-space"></div>
    <div class="reset" id ="resetButton5"></div>
    <div class="sharelist-group" id="sharelist-group6"></div>
    <div class="custom-space"></div>
    <div class="reset" id ="resetButton6"></div>
    <div class="sharelist-group" id="sharelist-group7"></div>
    <div class="custom-space"></div>
    <div class="reset" id ="resetButton7"></div>
    <div class="sharelist-group" id="sharelist-group8"></div>
    <div class="custom-space"></div>
    <div class="reset" id ="resetButton8"></div>
    <div class="sharelist-group" id="sharelist-group9"></div>
    <div class="custom-space"></div>
    <div class="reset" id ="resetButton9"></div>
    <div class="sharelist-group" id="sharelist-group10"></div>
    <div class="custom-space"></div>
    <div class="reset" id ="resetButton10"></div>
    <div class="sharelist-group" id="sharelist-group11"></div>
    <div class="custom-space"></div>
    <div class="reset" id ="resetButton11"></div>
    <div class="sharelist-group" id="sharelist-group12"></div>
    <div class="custom-space"></div>
    <div class="reset" id ="resetButton12"></div>
    <div class="global-group" id="Identity-group"></div>
    <br>
    <div class="sharelist-group" id="sharelist-group13"></div>
    <div class="custom-space"></div>
    <div class="reset" id ="resetButton13"></div>
    <div class="sharelist-group" id="sharelist-group14"></div>
    <div class="custom-space"></div>
    <div class="reset" id ="resetButton14"></div>
    <div class="sharelist-group" id="sharelist-group15"></div>
    <div class="custom-space"></div>
    <div class="reset" id ="resetButton15"></div>
    <div class="sharelist-group" id="sharelist-group16"></div>
    <div class="custom-space"></div>
    <div class="reset" id ="resetButton16"></div>
    <div class="sharelist-group" id="sharelist-group17"></div>
    <div class="custom-space"></div>
    <div class="reset" id ="resetButton17"></div>
    <div class="sharelist-group" id="sharelist-group18"></div>
    <div class="custom-space"></div>
    <div class="reset" id ="resetButton18"></div>
    <div class="sharelist-group" id="sharelist-group19"></div>
    <div class="custom-space"></div>
    <div class="reset" id ="resetButton19"></div>
    <div class="sharelist-group" id="sharelist-group20"></div>
    <div class="custom-space"></div>
    <div class="reset" id ="resetButton20"></div>
    <div class="sharelist-group" id="sharelist-group21"></div>
    <div class="custom-space"></div>
    <div class="reset" id ="resetButton21"></div>
    <div class="sharelist-group" id="sharelist-group22"></div>
    <div class="custom-space"></div>
    <div class="reset" id ="resetButton22"></div>
    <div class="sharelist-group" id="sharelist-group23"></div>
    <div class="custom-space"></div>
    <div class="reset" id ="resetButton23"></div>
    <div class="sharelist-group" id="sharelist-group24"></div>
    <div class="custom-space"></div>
    <div class="reset" id ="resetButton24"></div>
    <div class="global-group" id="EGO-group"></div>
    <br>
    <p>共有用URL: <textarea class="share-url-textarea" readonly></textarea></p>
    <button id="blink-sort-reset">並びを初期化する</button>
    <button id="copyButton">共有用URLをコピー</button>
    <br>
    <br>
    <p>もし共有用URLが長くて不便だと感じたら、短縮URLを生成することもできます。<br>
    ただし、生成数上限に達しており、生成できない可能性があります。<br>
    スマホだと短縮URLのコピーにおそらく失敗するので、その際は手動でコピーしてください。</p>
    <p>短縮URL: <textarea class="shortened-url-textarea" readonly></textarea></p>
    <button id="shortenButton" style="margin-bottom: 50px;">短縮URLを生成してコピー</button>

    <script>
    document.addEventListener("DOMContentLoaded", () => {
        const defaultState = 4; // 初期状態
        const maxState = 4; // 強化段階の最大値
        const defaultLv = 0; //未所持を想定
        const maxLv = 55; //レベル上限解放時はここを書き換える
        const lvCheckbox = document.getElementById("enableLv");
        const groupsData = [
        { sharelistId: 'sharelist-group1', groupCount: 14, startId: 1001 },
        { sharelistId: 'sharelist-group2', groupCount: 13, startId: 2001 },
        { sharelistId: 'sharelist-group3', groupCount: 13, startId: 3001 },
        { sharelistId: 'sharelist-group4', groupCount: 12, startId: 4001 },
        { sharelistId: 'sharelist-group5', groupCount: 13, startId: 5001 },
        { sharelistId: 'sharelist-group6', groupCount: 13, startId: 6001 },
        { sharelistId: 'sharelist-group7', groupCount: 14, startId: 7001 },
        { sharelistId: 'sharelist-group8', groupCount: 13, startId: 8001 },
        { sharelistId: 'sharelist-group9', groupCount: 13, startId: 9001 },
        { sharelistId: 'sharelist-group10', groupCount: 14, startId: 10001 },
        { sharelistId: 'sharelist-group11', groupCount: 13, startId: 11001 },
        { sharelistId: 'sharelist-group12', groupCount: 13, startId: 12001 },
        { sharelistId: 'sharelist-group13', groupCount: 7, startId: 13001 },
        { sharelistId: 'sharelist-group14', groupCount: 9, startId: 14001 },
        { sharelistId: 'sharelist-group15', groupCount: 9, startId: 15001 },
        { sharelistId: 'sharelist-group16', groupCount: 8, startId: 16001 },
        { sharelistId: 'sharelist-group17', groupCount: 8, startId: 17001 },
        { sharelistId: 'sharelist-group18', groupCount: 9, startId: 18001 },
        { sharelistId: 'sharelist-group19', groupCount: 8, startId: 19001 },
        { sharelistId: 'sharelist-group20', groupCount: 10, startId: 20001 },
        { sharelistId: 'sharelist-group21', groupCount: 8, startId: 21001 },
        { sharelistId: 'sharelist-group22', groupCount: 8, startId: 22001 },
        { sharelistId: 'sharelist-group23', groupCount: 8, startId: 23001 },
        { sharelistId: 'sharelist-group24', groupCount: 9, startId: 24001 },
        ];// 新規人格E.G.Oを追加するときはここを変更する

        groupsData.forEach(({ sharelistId, groupCount, startId }) => {
            const sharelistGroup = document.getElementById(sharelistId);

            for (let i = 0; i < groupCount; i++) {
                const container = document.createElement('div');
                container.classList.add('container');
                container.dataset.id = startId + i;

                // 画像要素を作成
                const img = document.createElement('img');
                img.dataset.id = startId + i;
                img.classList.add('img');

                const overlay = document.createElement('img');
                overlay.dataset.id = startId + i;
                overlay.classList.add('overlay');

                const altValue = defaultState;
                syncAlt(img, overlay, altValue);

                img.src = imgURL(img.dataset.id, altValue);
                overlay.src = overlayURL(overlay.dataset.id, altValue);

                container.appendChild(img);
                container.appendChild(overlay);
                
                // Lvの入力フィールド(条件付きで追加)
                if (startId + i < 13000) {
                    const lvContainer = document.createElement('div');
                    lvContainer.classList.add('lv-container');
                    const lvText = document.createElement('span');
                    lvText.textContent = 'Lv:';
                    lvText.classList.add('lvtext');
                    const lvInput = document.createElement('input');
                    lvInput.type = 'number';
                    lvInput.value = defaultLv;
                    lvInput.min = 0;
                    lvInput.max = maxLv; 
                    lvInput.step = 1; //レベルは整数のみ
                    lvInput.dataset.id = startId + i;
                    lvInput.classList.add('lvinput');

                    lvInput.addEventListener('input', function () {
                        let value = lvInput.value.trim();
                        if (value === "") {
                            lvInput.value = null; // nullに設定
                            return;
                        }
                        value = parseInt(value);
                        if (isNaN(value) || value % 1 !== 0) {
                            lvInput.value = Math.floor(lvInput.value); // 整数に変換
                            return; // 処理を終了
                        }
                        if (value < 0) {
                            lvInput.value = 0;
                        } else if (value > maxLv) {
                            lvInput.value = maxLv;
                        }
                    }); 

                    lvContainer.appendChild(lvText);
                    lvContainer.appendChild(lvInput);
                    container.appendChild(lvContainer);
                }

                // sharelistGroupに追加
                sharelistGroup.appendChild(container);
            }
        });

        function imgURL(id, alt) {
            const baseImageUrl = "https://raw.githubusercontent.com/394ast/limbus.sharetool/main/";
            const monochrome = document.getElementById("monochrome").checked;
            const uptie = document.querySelector('input[name="Uptie"]:checked')?.value;

            let basePath = "";
            let suffix = ".jpg";

            if (id < 13000) {
                if (alt === 3 || alt === 4) {
                    basePath = `Identities.${uptie === "before" ? "Before" : "After"}`;
                    suffix = `${uptie === "before" ? ".1" : ".3"}.jpg`;
                } else {
                    if (alt === 0 && monochrome) {
                        basePath = `Identities.Mono.${uptie === "after" ? "After" : "Before"}`;
                        suffix = `${uptie === "after" ? ".3" : ".1"}.mono.jpg`;
                    } else {
                        basePath = `Identities.${uptie === "after" ? "After" : "Before"}`;
                        suffix = `${uptie === "after" ? ".3" : ".1"}.jpg`;
                    }
                }
            } else {
                basePath = `EGO${alt === 0 && monochrome ? ".Mono" : ""}`;
                suffix = alt === 0 && monochrome ? ".mono.jpg" : ".jpg";
            }
            return `${baseImageUrl}${basePath}/${id}${suffix}`;
        }
        
        function overlayURL(id, alt) {
            const baseImageUrl = "https://raw.githubusercontent.com/394ast/limbus.sharetool/main/Resource/";
            let category = id < 13000 ? "Uptie" : "Threadspin";
            let fileName = alt === 0 ? "NIP.jpg" : `${category}${alt}.jpg`;
            return `${baseImageUrl}${fileName}`;
        }

        function syncAlt(img, overlay, altValue) {
            img.alt = altValue;
            overlay.alt = altValue;
        }

        const groupNames = [
        '　 イサン  　', ' ファウスト  ', 'ドンキホーテ', '　　良秀　　', '　ムルソー　', '　 ホンル  　', 
        'ヒースクリフ', 'イシュメール', '　ロージャ　', ' シンクレア  ', ' ウーティス  ', ' グレゴール  ',
        '　 イサン  　', ' ファウスト  ', 'ドンキホーテ', '　　良秀　　', '　ムルソー　', '　 ホンル  　', 
        'ヒースクリフ', 'イシュメール', '　ロージャ　', ' シンクレア  ', ' ウーティス  ', ' グレゴール  '
        ];

        // グループごとのリセットボタンを生成
        groupNames.forEach((groupName, index) => {
        const resetDiv = document.getElementById(`resetButton${index + 1}`);
    
            if (resetDiv) {
                const span = document.createElement('span');
                span.textContent = groupName + ':';
                resetDiv.appendChild(span);

                for (let i = 0; i <= 4; i++) {
                    const button = document.createElement('button');
                    button.id = `reset${index + 1}-${i}`;
            
                if (index + 1 <= 12) {
                    button.textContent = i === 0 ? '全て未所持' : `全て同期${i}`;
                } else {
                    button.textContent = i === 0 ? '全て未所持' : `全て解析${i}`;
                }
                resetDiv.appendChild(button);
                }
            }
        });

        // チェックボックスの状態に応じてlv-containerの表示/非表示を切り替える
        lvCheckbox.addEventListener('change', () => {
            const lvContainers = document.querySelectorAll('.lv-container');
            lvContainers.forEach(lvContainer => {
            lvContainer.style.display = lvCheckbox.checked ? 'flex' : 'none';
            });
            customSpace();
            updateUrl();
        });

        const enableResetCheckbox = document.getElementById('enableReset');
        enableResetCheckbox.addEventListener('change', function () {
            const resetButtons = document.querySelectorAll('.reset');
            resetButtons.forEach(button => {
                button.style.display = enableResetCheckbox.checked ? 'flex' : 'none';
            });
            customSpace();
        });

        function customSpace(){
            const customSpaces = document.querySelectorAll('.custom-space');
            const lvChecked = lvCheckbox.checked;
            const resetChecked = enableResetCheckbox.checked;
            customSpaces.forEach(space => {
                space.style.display = (lvChecked || resetChecked) ? 'none' : 'flex';
            });
        }

        //状態復元処理
        let urlParams = new URLSearchParams(window.location.search);
        // window.location.searchの文字列を取得し、&amp;を&に置き換え(tinyURLのリダイレクトに対応)
        let searchString = window.location.search.replace(/&amp;/g, '&');
        urlParams = new URLSearchParams(searchString);
        const imgParam = urlParams.get("img");
        const lvParam = urlParams.get("lv");
        if(imgParam){
            const decompressedImg = decompressImgData(imgParam);
            restoreImg(decompressedImg);
        }
        if(lvParam){
            document.getElementById("enableLv").checked = true;
            lvCheckbox.dispatchEvent(new Event('change')); // 切り替えイベントを発火
            const decompressedlv = decompresslvData(lvParam);
            restorelv(decompressedlv);
        }

        // グローバルグループを生成
        const identityGroup = document.getElementById('Identity-group');
        const egoGroup = document.getElementById('EGO-group');

        groupsData.forEach(({ sharelistId }) => {
            const sharelistGroup = document.getElementById(sharelistId);
            if (sharelistGroup) {
                const groupNumber = parseInt(sharelistId.replace('sharelist-group', ''), 10); // IDから番号取得
                const targetGroup = groupNumber <= 12 ? identityGroup : egoGroup; // 振り分け先を決定

                // 各sharelist-group内のコンテナを対象グローバルグループに追加
                Array.from(sharelistGroup.getElementsByClassName('container')).forEach(container => {
                    targetGroup.appendChild(container.cloneNode(true)); // コピーして追加
                });
            }
        });

        // ページが読み込まれたときにもURLを更新
        updateUrl();
        updateImages();

        // クリック時の状態変更処理
        document.querySelectorAll(".container").forEach(container => {
            container.addEventListener("click", (event) => {
            // クリックされたのがlvだった場合、親のクリックイベントを発火させない
            if (event.target.classList.contains("lvinput") || event.target.classList.contains("lvtext")) {
                event.stopPropagation();
                return;
            }
            const img = container.querySelector(".img");
            const overlay = container.querySelector(".overlay");
            const id = container.dataset.id;
            let currentState = parseInt(img.alt, 10) || 0; // alt属性から現在の状態を取得
            currentState = (currentState + 1) % (maxState + 1); // 状態を循環
            syncAlt(img, overlay, currentState);

            img.src = imgURL(img.dataset.id, currentState);
            overlay.src = overlayURL(overlay.dataset.id, currentState);

            syncBetweenGroups(img); //個別グローバル同期
            updateUrl(); // URLを更新
            });
        });

        //レベル変更時の処理（スピンボタンの遅延）
        let debounceTimeout;

        document.querySelectorAll('.lvinput').forEach(lvInput => {
            lvInput.addEventListener('input', (event) => {
                clearTimeout(debounceTimeout); // 既存のタイマーをクリア
                debounceTimeout = setTimeout(() => {
                    syncBetweenGroups(lvInput); //個別グローバル同期
                    updateUrl(); // 一定時間後に呼び出し
                }, 500); // 500ミリ秒後に呼び出し（適宜調整可能）
            });
        });

        //URL更新関数
        function updateUrl() {
            // ラジオボタンが選択されている場合、メッセージを表示して処理を停止
            const selectedRadio = document.querySelector('input[name="sort"]:checked');
            if (selectedRadio) {
                document.querySelector('.share-url-textarea').value = "ソート中は共有用URLを生成できません。「並びを初期化する」ボタンを押してください。";
                document.querySelector('.shortened-url-textarea').value = "ソート中は共有用URLを生成できません。「並びを初期化する」ボタンを押してください。";
                return; // URL生成処理を中止
            }
            
            const enableLv = document.getElementById("enableLv").checked;
            const baseUrl = "https://394ast.github.io/limbus.sharetool/";
            const compressedImgData = compressImgData();
            const encodedImgData = toUrlSafeBase64(compressedImgData);
            let url = `${baseUrl}?img=${encodedImgData}`;
    
            // lvが有効なら、lvのデータも追加
            if(enableLv){
                const compressedlvData = compresslvData();
                url += `&lv=${compressedlvData}`;
            }

            // クラス名でテキストエリアを取得して書き換え
            const shareUrl = document.querySelector('.share-url-textarea');
            shareUrl.value = url;
            // テキストエリアの大きさを調整
            adjustTextareaHeight();
            // 短縮用URLを消去
            document.querySelector('.shortened-url-textarea').value = '';
        }

        // 圧縮関数（ランレングス圧縮）
        function runLengthEncode(data) {
            let result = '';
            let count = 1;
            for (let i = 1; i < data.length; i++) {
                if (data[i] === data[i - 1]) {
                count++;
            } else {
                result += count.toString(36) + data[i - 1]; // 36進数で表記
            count = 1;
            }
            }
        // 最後の部分を追加、最後の文字が'0'の場合は追加しない
            if (data[data.length - 1] !== '0') {
            result += count.toString(36) + data[data.length - 1];
            }
        return result;
        }
        
        // 解凍関数（ランレングス圧縮の逆）
        function runLengthDecode(encodedData) {
            let result = [];
            let i = 0;
            while (i < encodedData.length) {
                let count = parseInt(encodedData[i],36); // 
                let state = encodedData[i + 1];
                for (let j = 0; j < count; j++) {
                    result.push(state);
                }
                i += 2; // 次のペアへ
            }
        return result;
        }

        // 圧縮処理
        function compressImgData() {
            const separator = '-'; // グループを区切るセパレータ
            // グループごとの状態を取得し、連結して返す
            const groupStates = groupsData.map(({ sharelistId }) => {
                const sharelistGroup = document.getElementById(sharelistId);
                const images = sharelistGroup.querySelectorAll(".img");
                const states = Array.from(images).map(img => parseInt(img.alt, 10) || 0);
                const allstates = states.join(""); // グループ内の状態を連結
                const compressedImgDataR =  `R${runLengthEncode(allstates)}`;
                const compressedImgData0 = allstates.replace(/0+$/, '');
                return compressedImgDataR.length < compressedImgData0.length ? compressedImgDataR : compressedImgData0;
            });    
        return groupStates.join(separator); // グループ間をseparatorで区切る
        }

        function compresslvData() {
            // sharelist-groupクラス内のlvInput要素を取得
            const lvInputs = document.querySelectorAll('.sharelist-group .lvinput');
            const lvValues = [];
            lvInputs.forEach(lvInput => {
                const id = lvInput.dataset.id;
                // 対応するimg要素を取得
                const img = document.querySelector(`.container[data-id="${id}"] .img`);
                // imgのaltが0以外の場合(所持している人格)、そのlvInputの値を取得
                if (img && parseInt(img.alt, 10) !== 0) {
                    const value = lvInput.value.trim() === "" ? "00" : parseInt(lvInput.value).toString(16).padStart(2, '0');
                    lvValues.push(value);// null入力にも対応
                }
            });
            let lvString = lvValues.join(""); 
            let compressedlvData = "";
            let leftover = "";
            while (lvString.length >= 5) {
                let chunk = lvString.slice(0, 5);
                lvString = lvString.slice(5); // 残りの文字列を更新
                // 16進数から10進数に変換
                let decimal = parseInt(chunk, 16);
                // 10進数から32進数に変換
                let base32 = decimal.toString(32);
                base32 = base32.padStart(4,'0'); // 4文字になるように
                compressedlvData += base32;
            } // 16進数5文字を32進数4文字に変換
            // 余りを繋げる
            leftover = lvString;
            compressedlvData += `-${leftover}`;
            return compressedlvData;
        }
        
        // 解凍処理
        function decompressImgData(encodedImgData) {
            const decodedImgData = fromUrlSafeBase64(encodedImgData);
            const groups = decodedImgData.split('-');
            const decompressedImg = [];

            groups.forEach((group, index) => {
                const { groupCount } = Object.values(groupsData)[index];
                let decoded = [];

                if (group) { // 空でないグループのみ処理
                    if (group.startsWith("R")) { // group の先頭が 'R' の場合
                        const modifiedGroup = group.slice(1); // 先頭の 'R' を削除
                        decoded = runLengthDecode(modifiedGroup);
                    } else {
                        decoded = [...group]; // group をそのまま文字配列に変換
                    }
                }

                // decoded の長さを count に合わせる
                while (decoded.length < groupCount) {
                decoded.push("0"); // 不足分を補完
                }
                decompressedImg.push(...decoded);
            });
            return decompressedImg;
        }

        function decompresslvData(lvParam){
            const parts = lvParam.split('-');
            let base32 = parts[0];
            const remainder16 = parts[1]; 
            let base16 = "";
            while(base32.length >=4){
                let chunk = base32.slice(0,4);
                base32 = base32.slice(4); // 残りの文字列を更新
                let decimal = parseInt(chunk, 32);
                let push16 = decimal.toString(16);
                push16 = push16.padStart(5, '0'); // 5文字になるように
                base16 += push16;
            }
            //余りを繋げる
            base16 += remainder16;
            if (base16.length % 2 !== 0) {
                alert("lvの共有にエラーが発生しました");
            }
            let decompressedlv = [];
            for (let i = 0; i < base16.length; i += 2) {
                let hexPair = base16.slice(i, i + 2); // 2文字を取り出す
                let decimalValue = parseInt(hexPair, 16); // 16進数を10進数に変換
                decompressedlv.push(decimalValue);
            }
        return decompressedlv;
        }

        // 状態復元用関数 
        function restoreImg(decompressedImg){
            let idx = 0;

            groupsData.forEach(({ startId, groupCount }) => {
                const groupImg = decompressedImg.slice(idx, idx + groupCount); // グループ分の状態を取り出す
                idx += groupCount;

                for (let i = 0; i < groupCount; i++) {
                    const id = startId + i;
                    const state = groupImg[i];
                    const img = document.querySelector(`img[data-id="${id}"]`);
                    const overlay = document.querySelector(`img[data-id="${id}"].overlay`);
                    if (img) {
                        syncAlt(img, overlay, state);
                    }
                }
            });
        }

        function restorelv(decompressedlv){
            const lvInputs = document.querySelectorAll('.lvinput'); // lvInput を取得
            let index = 0; // decompressedlv の配列インデックス

            lvInputs.forEach(lvInput => {
                const imgElement = lvInput.closest('.container')?.querySelector('.img'); // 対応する img を取得
                    if (imgElement && imgElement.alt === '0') {
                        // img.alt が 0 の場合、配列は進めずスキップ
                        return;
                    }
                    if (index < decompressedlv.length) {
                        // 条件に合致する場合のみ lvInput の値を更新
                        lvInput.value = decompressedlv[index];
                        index++; // 配列のインデックスを進める
                    }
            });

            // 配列が余った場合のエラーチェック
            if (index < decompressedlv.length) {
                alert("lvの共有にエラーが発生しました。");
            }
        }

        function resetPrimary(state, startId, endId) {
            const images = document.querySelectorAll('img');
            let currentState = state ;
            images.forEach(img => {
                const id = parseInt(img.dataset.id, 10); 
                if(id >= startId && id <= endId){
                    if (id % 1000 != 1 ) {
                        currentState = 0 ;
                    }else{
                        currentState = state ;
                    }
                const overlay = document.querySelector(`img[data-id="${id}"].overlay`);
                syncAlt(img, overlay, currentState);
                img.src = imgURL(id, currentState);
                overlay.src = overlayURL(id, currentState);
                }
            });
            updateUrl();
        }

        function resetState(state, startId, endId){
            const images = document.querySelectorAll('img');
            images.forEach(img => {
                const id = parseInt(img.dataset.id, 10); 
                if(id >= startId && id <= endId){
                    const overlay = document.querySelector(`img[data-id="${id}"].overlay`);
                    syncAlt(img, overlay, state);
                    img.src = imgURL(id, state);
                    overlay.src = overlayURL(id, state);
                }
            });
            updateUrl();
        }
        
        document.getElementById(`reset0-1`).addEventListener('click', () => resetPrimary(1,1001,25000));
        document.getElementById(`reset0-2`).addEventListener('click', () => resetPrimary(2,1001,25000));
        document.getElementById(`reset0-3`).addEventListener('click', () => resetPrimary(3,1001,25000));
        document.getElementById("Identity-reset1").addEventListener("click", () => resetState(1,1001,13000));
        document.getElementById("Identity-reset2").addEventListener("click", () => resetState(2,1001,13000));
        document.getElementById("Identity-reset3").addEventListener("click", () => resetState(3,1001,13000));
        document.getElementById("Identity-reset4").addEventListener("click", () => resetState(4,1001,13000));
        document.getElementById("E.G.O-reset1").addEventListener("click", () => resetState(1,13001,25000));
        document.getElementById("E.G.O-reset2").addEventListener("click", () => resetState(2,13001,25000));
        document.getElementById("E.G.O-reset3").addEventListener("click", () => resetState(3,13001,25000));
        document.getElementById("E.G.O-reset4").addEventListener("click", () => resetState(4,13001,25000));

        for (let X = 1; X <= 24; X++) {  // グループ1〜24
            for (let Y = 0; Y <= 4; Y++) {  // ボタン0〜4
                const buttonId = `reset${X}-${Y}`;
                const button = document.getElementById(buttonId);
                if (button) {
                    button.addEventListener('click', () => {
                        resetState(Y, 1000 * X + 1, 1000 * (X + 1));
                    });
                }
            }
        }

        // テキストエリアの調整関数
        function adjustTextareaHeight() {
            const textareas = document.querySelectorAll('.share-url-textarea');
    
            textareas.forEach(textarea => {
                // 高さを自動的にリセット
                textarea.style.height = 'auto'; 
        
                // テキストエリアの内容に基づいて高さを調整
                textarea.style.height = textarea.scrollHeight + 'px';
            });
        }

        // ページのリサイズ時にも調整
        window.addEventListener('resize', adjustTextareaHeight);

        // ページのリサイズ時にも調整
        window.addEventListener('resize', adjustTextareaHeight);

        // URLセーフBase64エンコード関数
        function toUrlSafeBase64(data) {
            return btoa(data)
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, ''); 
        }

        // URLセーフBase64デコード関数
        function fromUrlSafeBase64(data) {
            data = data.replace(/-/g, '+').replace(/_/g, '/');
            // パディングが不足している場合は補完
            while (data.length % 4) {
                data += '=';
            }
        return atob(data);
        }

        // 共有用URLのコピーボタンの処理
        document.getElementById('copyButton').addEventListener('click', async function () {
            const textarea = document.querySelector('.share-url-textarea');
            const url = textarea.value;
            try {
                // Clipboard APIを使用してクリップボードにコピー
                await navigator.clipboard.writeText(url);
                alert('共有用URLをコピーしました');
            } catch (err) {
                alert('コピーに失敗しました。');
            }
        });

        //短縮ボタンの処理
        let isProcessing = false;

        document.getElementById("shortenButton").addEventListener("click", async function () {
            // 既に処理中の場合は無視
            if (isProcessing) return;

            isProcessing = true; // 処理中フラグをセット

            const shareUrlElement = document.querySelector('.share-url-textarea');
            const shortenedUrlElement = document.querySelector('.shortened-url-textarea');
            const shareUrl = shareUrlElement.value.trim(); // テキストエリアの値を取得

            // URLが空の場合はエラーメッセージをアラート表示
            if (!shareUrl) {
                alert("共有用URLが設定されていません。");
                setTimeout(() => {
                isProcessing = false; 
                }, 1000);
                return;
            }

            try {
                // tinyurl APIを呼び出してURLを短縮
                const response = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(shareUrl)}`);
                
                if (response.ok) {
                    const baseUrl = "https://tinyurl.com/";
                    let shortUrl = await response.text();
                    let shortPreviewUrl = baseUrl + "preview/" + shortUrl.slice(baseUrl.length);
                    shortenedUrlElement.value = shortPreviewUrl;
                    // クリップボードにコピー
                    try {
                        await navigator.clipboard.writeText(shortPreviewUrl);
                        alert("URLを短縮してコピーしました");
                    } catch (clipboardError) {
                    // クリップボードコピーに失敗した場合
                        alert(`短縮は完了しましたが、コピーに失敗しました。手動でコピーしてください。`);
                    }
                } else {
                    throw new Error("URLの短縮に失敗しました。");
                }

            } catch (error) {
                // エラーをアラート表示
                alert(`エラー: ${error.message}`);
            }finally {
                // 処理完了後に1000ms待機してフラグを解除
                setTimeout(() => {
                isProcessing = false;
                }, 1000);
            }
        });

    
        //  個別グローバルの同期処理  
        function syncBetweenGroups(changedElement) {
            const container = changedElement.closest('.container'); // 親コンテナを特定
            if (!container) return;

            const containerId = container.dataset.id; // コンテナのIDを取得
            const parentGroup = container.closest('.sharelist-group, .global-group'); // 親グループを特定

            if (!parentGroup) return;

            if (parentGroup.classList.contains('sharelist-group')) {
                // sharelist-group に変更があった場合、global-group に同期
                const targetGroup = Math.floor(containerId / 1000) <= 12 ? identityGroup : egoGroup;
                const targetContainer = targetGroup.querySelector(`.container[data-id="${containerId}"]`);
                if (targetContainer) {
                    syncContainerContents(container, targetContainer);
                }
            } else if (parentGroup.classList.contains('global-group')) {
                // global-group に変更があった場合、sharelist-group に同期
                const groupNumber = Math.floor(containerId / 1000);
                const targetGroupId = `sharelist-group${groupNumber}`;
                const targetGroup = document.getElementById(targetGroupId);
                const targetContainer = targetGroup?.querySelector(`.container[data-id="${containerId}"]`);
                if (targetContainer) {
                    syncContainerContents(container, targetContainer);
                }
            }
        }

        function syncContainerContents(sourceContainer, targetContainer) {
            // 画像とオーバーレイ画像の情報を同期
            const sourceImg = sourceContainer.querySelector('img');
            const sourceOverlay = sourceContainer.querySelector('.overlay');
            const targetImg = targetContainer.querySelector('img');
            const targetOverlay = targetContainer.querySelector('.overlay');

            if (sourceImg && targetImg && sourceOverlay && targetOverlay) {
                targetImg.src = sourceImg.src;
                targetImg.alt = sourceImg.alt;
                targetOverlay.src = sourceOverlay.src;
                targetOverlay.alt = sourceOverlay.alt;
            }

            // レベル情報を同期
            const sourceLvInput = sourceContainer.querySelector('.lvinput');
            const targetLvInput = targetContainer.querySelector('.lvinput');
            if (sourceLvInput && targetLvInput) {
                targetLvInput.value = sourceLvInput.value;
            }
        }

        function showGlobalGroup() {
            document.querySelectorAll('.sharelist-group').forEach(group => {
                group.style.display = 'none';
            });
            document.querySelectorAll('.global-group').forEach(group => {
                group.style.display = 'flex';
            });
        }

        function showSharelistGroup() {
            document.querySelectorAll('.sharelist-group').forEach(group => {
                group.style.display = 'flex';
            });
            document.querySelectorAll('.global-group').forEach(group => {
                group.style.display = 'none';
            });
        }
        
        const altZeroCheckbox = document.getElementById('none-alt0');
        const altFlexCheckbox = document.getElementById('flex-alt0');
        const specificIdCheckbox = document.getElementById('none-id1');

        function handleCheckboxChange(changedCheckbox, otherCheckbox) {
            if (changedCheckbox.checked) {
                otherCheckbox.checked = false; // もう一方のチェックボックスをオフ
            }
            changeCheckbox();
        }

        function changeCheckbox() {
            document.querySelectorAll('.container').forEach(container => {
                container.style.display = 'flex';
            });

            const toggleDisplay = (condition) => {
                document.querySelectorAll('.container .img').forEach(img => {
                const container = img.closest('.container');
                const id = parseInt(img.dataset.id, 10);
                const alt = parseInt(img.alt, 10);
                if (condition(alt, id)) {
                    container.style.display = 'none';
                }
                });
            };
            if (altZeroCheckbox.checked && altFlexCheckbox.checked) {
            document.querySelectorAll('.container').forEach(container => {
                container.style.display = 'none';
                });
                 return;
            } // handleCheckboxChangeにより起動しないはずだけど一応残す
            if (altZeroCheckbox.checked) {
                toggleDisplay((alt, id) =>
                    specificIdCheckbox.checked
                        ? alt === 0 || (id % 1000 === 1 && id >= 1001 && id <= 24001)
                        : alt === 0
                    );
                return;
            }
            if (altFlexCheckbox.checked) {
                toggleDisplay((alt, id) =>
                    specificIdCheckbox.checked
                        ? alt !== 0 || (id % 1000 === 1 && id >= 1001 && id <= 24001)
                        : alt !== 0
                    );
                return;
            }
            if (specificIdCheckbox.checked) {
                toggleDisplay((_, id) => id % 1000 === 1 && id >= 1001 && id <= 24001);
            }
        }

        altZeroCheckbox.addEventListener('change', () => handleCheckboxChange(altZeroCheckbox, altFlexCheckbox));
        altFlexCheckbox.addEventListener('change', () => handleCheckboxChange(altFlexCheckbox, altZeroCheckbox));
        specificIdCheckbox.addEventListener('change', changeCheckbox);

        function sortContainers(groupId, sortBy = 'data-id', order = 'desc') {
            const sharelistGroup = document.getElementById(groupId);
            if (!sharelistGroup) return;

            // 子要素（container）のリストを取得
            const containers = Array.from(sharelistGroup.getElementsByClassName('container'));

            // 並べ替え条件に基づいてソート
            containers.sort((a, b) => {
                let valueA, valueB;

                // 並べ替え基準に応じて値を取得
                if (sortBy === 'data-id') {
                    valueA = parseInt(a.dataset.id);
                    valueB = parseInt(b.dataset.id);
                } else if (sortBy === 'img.alt') {
                    valueA = a.querySelector('img')?.alt || '';
                    valueB = b.querySelector('img')?.alt || '';
                    if (valueA === valueB) {
                        valueA = parseInt(a.querySelector('.lvinput')?.value || 0);
                        valueB = parseInt(b.querySelector('.lvinput')?.value || 0);
                    }
                } else if (sortBy === 'lvInput') {
                    valueA = parseInt(a.querySelector('.lvinput')?.value || 0);
                    valueB = parseInt(b.querySelector('.lvinput')?.value || 0);
                    if (valueA === valueB) {
                        valueA = a.querySelector('img')?.alt || '';
                        valueB = b.querySelector('img')?.alt || '';
                    }
                } else {
                    return 0; // 不正なsortByが指定された場合、並び替えを行わない
                }

                // ソート順序に基づいて比較
                if (order === 'asc') {
                    return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
                } else {
                    return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
                }
            });

            // 並べ替え後の要素を再配置
            containers.forEach(container => sharelistGroup.appendChild(container));
        }

        const radioButtons = document.querySelectorAll('input[name="sort"]');

        // ラジオボタンが選択された時に実行される処理
        document.querySelectorAll('input[name="sort"]').forEach((radio) => {
            radio.addEventListener('change', (event) => {
                const value = event.target.value;

                // それぞれのグループに対して処理を適用
                if (value === 'option1' || value === 'option2') {
                    // 「それぞれの囚人ごとに」のグループに対して
                    showSharelistGroup();
                    document.querySelectorAll('.sharelist-group').forEach(group => {
                        if (value === 'option1') {
                            sortContainers(group.id, 'img.alt');
                        } else if (value === 'option2') {
                            sortContainers(group.id, 'lvInput');
                        }
                    });
                } else if (value === 'option3' || value === 'option4') {
                    // 「すべての囚人を」のグループに対して
                    showGlobalGroup();
                    document.querySelectorAll('.global-group').forEach(group => {
                        if (value === 'option3') {
                            sortContainers(group.id, 'img.alt');
                        } else if (value === 'option4') {
                            sortContainers(group.id, 'lvInput');
                        }
                    });
                }
                document.getElementById('blink-sort-reset').style.display = 'block'; // 下の方にリセットボタンを表示
                updateUrl();
            });
        });

        // 並びを初期化する関数
        function resetSorting() {
            const radios = document.querySelectorAll('input[name="sort"]');
            radios.forEach(radio => radio.checked = false);
            document.querySelectorAll('.sharelist-group').forEach(group => {
                sortContainers(group.id, 'data-id', 'asc');
            });
            document.querySelectorAll('.global-group').forEach(group => {
                sortContainers(group.id, 'data-id', 'asc');
            });
            showSharelistGroup();
            document.getElementById('blink-sort-reset').style.display = 'none';
            updateUrl();
        }

        document.getElementById('sort-reset').addEventListener('click', resetSorting);
        document.getElementById('blink-sort-reset').addEventListener('click', resetSorting);

        const imgSizeForm = document.getElementById('imgSizeForm');
        const customWidthInput = document.getElementById('customWidth');

        imgSizeForm.addEventListener('change', (event) => {
            if (event.target.type === 'radio') { // ラジオボタンのみ反応
                const selectedSize = event.target.value;
                if (selectedSize === 'custom') {
                    const container = document.querySelector('.container');
                    const currentWidth = container && container.style.width 
                    ? parseInt(container.style.width) : 80; //デフォルト
                    customWidthInput.value = currentWidth;
                    customWidthInput.disabled = false;
                    customWidthInput.focus();
                } else {
                    customWidthInput.value = "";
                    customWidthInput.disabled = true;
                }
                if (selectedSize === 'size1') applyCustomSize(60);
                if (selectedSize === 'size2') applyCustomSize(80);
                if (selectedSize === 'size3') applyCustomSize(120);
                if (selectedSize === 'size4') applyCustomSize(200);
            }
        });

        customWidthInput.addEventListener('input', () => {
            let customWidth = parseInt(customWidthInput.value, 10);
            customWidth = Math.max(20, Math.min(customWidth, 1000)); // 20～1000に制限
            setTimeout(() => applyCustomSize(customWidth), 100); // 0.1秒遅延
        });

        function applyCustomSize(width) {
            const containers = document.querySelectorAll('.container');
            const imgs = document.querySelectorAll('.img');
            const overlays = document.querySelectorAll('.overlay');
            const lvTexts = document.querySelectorAll('.lvtext');
            containers.forEach(container => {
                container.style.width = `${width}px`;
            });
            imgs.forEach(img => {
                img.style.width = `${width}px`;
                img.style.height = `${width}px`;
            });
            overlays.forEach(overlay => {
                overlay.style.width = `${(width * 6) / 7}px`;
                overlay.style.height = `${(width * 2) / 7}px`;
                overlay.style.top = `${(width * 5) / 7}px`;
                overlay.style.left = `${width / 14}px`;
            });
            lvTexts.forEach(lvText => {
                lvText.style.display = width < 80 ? 'none' : 'flex';
            });
        }   //画像サイズを調整する関数

        function updateImages() {
            document.querySelectorAll(".container").forEach(container => {
                const img = container.querySelector(".img");
                const overlay = container.querySelector(".overlay");
                const id = container.dataset.id;
                const alt = parseInt(img.alt, 10) || 0;
                img.src = imgURL(id, alt);
                overlay.src = overlayURL(id, alt);
            });
        }

        document.getElementById("monochrome").addEventListener("click", updateImages);
        document.querySelectorAll('input[name="Uptie"]').forEach(radio => {
            radio.addEventListener("change", updateImages);
        });

        document.getElementById("overlay").addEventListener("click", () => {
            const isChecked = document.getElementById("overlay").checked;
            document.querySelectorAll(".overlay").forEach(overlay => {
                overlay.style.display = isChecked ? "none" : "block";
            });
        });

    });
    </script>
</body>
</html>
